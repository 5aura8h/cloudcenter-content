. 'c:\Program Files\osmosix\etc\cliqr.ps1'
. 'c:\temp\userenv.ps1'

cd c:\opt\
# (New-Object System.Net.WebClient).DownloadFile('http://env.cliqrtech.com/sensu/sensu-0.21.0-1.msi', 'sensu-0.21.0-1.msi')
wget http://env.cliqrtech.com/sensu/sensu-0.21.0-1.msi -OutFile sensu-0.21.0-1.msi
.\sensu-0.21.0-1.msi /quiet

start-sleep -s 360
mkdir c:\opt\sensu\conf.d\
wget http://env.cliqrtech.com/sensu/client/sensu-client.xml -OutFile C:\opt\sensu\bin\sensu-client.xml
wget http://env.cliqrtech.com/sensu/client/rabbitmq.json -OutFile C:\opt\sensu\conf.d\rabbitmq.json
wget http://env.cliqrtech.com/sensu/client/client_win.json -OutFile C:\opt\sensu\conf.d\client.json

$clientConfigFile = 'C:\opt\sensu\conf.d\client.json'
$bakFile = "$clientConfigFile.!bk"
Ren $clientConfigFile -NewName $bakFile
Get-Content  $bakFile | %{$_  -creplace '%TIER_NAME%', $env:cliqrNodeId} | %{$_  -creplace '%TIER_IP%', $OSMOSIX_PUBLIC_IP}  | Set-Content $clientConfigFile

$rabbitConfigFile = 'C:\opt\sensu\conf.d\rabbitmq.json'
$bakFile = "$rabbitConfigFile.!bk"
Ren $rabbitConfigFile -NewName $bakFile
Get-Content  $bakFile | %{$_  -creplace '%SENSU_SERVER_IP%', $env:SENSU_SERVER_IP} | Set-Content $rabbitConfigFile

C:\opt\sensu\embedded\bin\gem install sensu-plugins-windows --no-ri --no-RDoc

new-service -name sensu-client -binaryPathName "c:\opt\sensu\bin\sensu-client.exe" -displayName "Sensu Client" -StartupType Auto 
start-service -name sensu-client
